package aoUrnToRam::Test;

require kermeta
require "platform:/resource/aoUrnToRam/test/tdd/aoUrnToIw/AoUrnTestFactory.kmt"
require "platform:/resource/aoUrnToRam/src/aoUrnToIw/Build.kmt"

using kermeta::standard
using kermeta::kunit
using oneurn::urn
using oneurn::ucm::map
using oneurn::urncore
using intermediateWorkflow

using kermeta::language::structure

class AoUrnToIwBuildTestCase inherits TestCase
{
	attribute factory:AoUrnTestFactory

	method setUp() is do
		factory:=AoUrnTestFactory.new
	end

	operation testBuildPathNode_NoInOut() is do
		var actual:StartPoint init factory.createStartPoint(void)
		actual.build
	
		assert(actual.iwNodes.size==0)
	end
	
	operation testBuildPathNode_In() is do
		var actual:StartPoint init factory.createStartPoint("in theInputName")
		actual.build
	
		assertIsNonVoidInstanceOf(IwInput, actual.iwNodes.one)
		assertStringEqual("theInputName",actual.iwNodes.one.name)
	end

	operation testBuildPathNode_Out() is do
		var actual:StartPoint init factory.createStartPoint("out theOutputName")
		actual.build
	
		assertIsNonVoidInstanceOf(IwOutput, actual.iwNodes.one)
		assertStringEqual("theOutputName",actual.iwNodes.one.name)
	end
	
	operation testBuildPathNode_InOut() is do
		var actual:StartPoint init factory.createStartPoint("out theOutputName in theInputName")
		actual.build
	
		assertIsNonVoidInstanceOf(IwOutput, actual.iwNodes.at(0))
		assertStringEqual("theOutputName",actual.iwNodes.at(0).name)
		
		assertIsNonVoidInstanceOf(IwInput, actual.iwNodes.at(1))
		assertStringEqual("theInputName",actual.iwNodes.at(1).name)
	end

	operation testBuildRespRef_NoInOut() is do
		var actual:RespRef init factory.createRespRef("theRespName",void)
		actual.build
	
		assertIsNonVoidInstanceOf(IwProcessingNode, actual.iwNodes.one)
		assertStringEqual("theRespName",actual.iwNodes.one.name)
	end
	
	operation testBuildEndPoint_NoInOut() is do
		var actual:EndPoint init factory.createEndPoint("theEndPoint",void)
		actual.build
	
		assertIsNonVoidInstanceOf(IwEndPoint, actual.iwNodes.one)
		assertStringEqual("theEndPoint",actual.iwNodes.one.name)
	end

	operation testBuildEndPoint_InOut() is do
		var actual:EndPoint init factory.createEndPoint("theEndPoint","out theOutputName in theInputName")
		actual.build
	
		assertIsNonVoidInstanceOf(IwOutput, actual.iwNodes.at(0))
		assertStringEqual("theOutputName",actual.iwNodes.at(0).name)
		
		assertIsNonVoidInstanceOf(IwInput, actual.iwNodes.at(1))
		assertStringEqual("theInputName",actual.iwNodes.at(1).name)
		
		assertIsNonVoidInstanceOf(IwEndPoint, actual.iwNodes.at(2))
		assertStringEqual("theEndPoint",actual.iwNodes.at(2).name)
	end

	operation testBuildUcmMap() is do
		var ucmMap:UCMmap init factory.createUcmMap("theUcmMapName")
		ucmMap.build()
	
		assertIsNonVoidInstanceOf(IwWorkflow, ucmMap.iwWorkflow)
		assertStringEqual("theUcmMapName",ucmMap.iwWorkflow.name)
	end
	
	operation testBuildUnrSpec() is do
		var urnSpec:URNspec init factory.createUrnSpec
		urnSpec.build()
	
		assertIsNonVoidInstanceOf(IwModel, urnSpec.iwModel)
	end
	
	//stle: dry
	//stle: more verbrose on assertion
	operation assertIsNonVoidInstanceOf(expected:kermeta::language::structure::Class, actual:Object) is do
		assertWithMsg(actual.isVoid==false,"IsVoid-> expected:false actual:true")
		assertWithMsg(actual.isInstanceOf(expected),"IsInstanceOf-> expected:\""+expected.toString()+"\"actual:\""+actual.getMetaClass().toString()+"\"")
	end

	
	operation assertStringEqual(expected:String, actual:String) is do
		assertWithMsg(expected==actual,"StringEqual-> expected:\""+expected+"\"actual:\""+actual+"\"")
	end
	
}